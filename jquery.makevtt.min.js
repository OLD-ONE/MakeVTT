!function(e){jQuery.fn.makeVTT=function(t,a){var n=e.extend(!0,{oAuth:null,wrapperId:"makeVTT",playbackRate:["1.0"],defaultVolume:1,trackIdPrefix:"track",setLanguage:{heading:{label:"Language",lang:""}},selectTrack:!1,ajaxTimeoutReTry:3,ajax:{type:"post",contentType:!1,processData:!1,url:"",data:{},dataType:"jsonp",timeout:1e4}},t),i={vertical:"",region:null,line:"auto",position:"auto",size:100,align:"center",lineAlign:"start",positionAlign:"auto",snapToLines:!0};a&&(i=e.extend({},i,a));var r,o,c,l,d,s,u,p,f,v,g,m,h,T,k,x,y,C,b,w=this.length>0&&this[0],A=this.length>0&&e(this[0]),L={},$=!1,V={id:"",text:"",startTime:"",endTime:""},N="",E=!1,S={},j={},z="WEBVTT - This file has cues.",I="This action cannot be undone.\nDo you want to continue?",D=function(e,t){return!!(e in t)},R=function(){B(),e("track").off("load"),e("track").map(function(){var t=e(this).attr("src").replace(/\?t=\d+$/,"")+"?t="+(new Date).getTime();e(this).attr({src:t})}),setTimeout(function(){e("track").one("load",R)},500)},W=function(){B(),e("track").off("error"),e("track").map(function(){var t=e(this).attr("src").replace(/\?t=\d+$/,"")+"?t="+(new Date).getTime();e(this).attr({src:t})}),setTimeout(function(){e("track").one("error",W)},500)},O=function(){$=l.find("option:selected").attr("data-track");for(var e=0;e<w.textTracks.length;e++)w.textTracks[e].mode=w.textTracks[e].id===$?"showing":"disabled"},B=function(){S={},E=!1,d.text(""),m.hide(),g.hide(),k.attr({readonly:"readonly"}).removeClass("editNow"),C.hide(),y.hide(),b.hide(),p.removeAttr("readonly").val(""),v.removeAttr("readonly").val(""),T.removeAttr("readonly").val(""),x.css({opacity:1}).off("click").on("click",H),e(".readyActiveCue").removeClass("editNow").off("keyup focus blur").on("keyup focus blur",Z),e(".setCurrentTime").css({opacity:1}).off("click").on("click",X),h.css({opacity:1}).off("click").on("click",Q),e.when(re(".vttLoading"),re(".cueLoading")).then(function(){for(var t=!1,a=0;a<w.textTracks.length;a++)"showing"===w.textTracks[a].mode?($=w.textTracks[a].id,t=!0,e("#"+$).on("cuechange",M)):e("#"+w.textTracks[a].id).off("cuechange");if(t||($=!1),t&&l.find("option:selected").attr("data-track")!==$&&(l.find("option").removeAttr("selected").prop("selected",!1),l.find("option[data-track='"+$+"']").attr("selected","selected").prop("selected",!0)),!t&&l.find("option:selected").attr("data-track")&&l.find("option").removeAttr("selected").prop("selected",!1),z="WEBVTT - "+l.find("option:selected").text(),$){var n=e("#"+$).attr("src");e.get(n).done(function(){b.show()}).fail(function(e){b.hide()}),P(),M().then(function(){e(".vttControlls").show(),oe(".vttLoading"),oe(".cueLoading")}).catch(function(e){console.log(e)})}else k.val(""),e(".vttControlls").hide(),oe(".vttLoading"),oe(".cueLoading")}).catch(function(e){console.log(e)})},P=function(){var e=L[$];e&&q(e)},q=function(e){var t=e.cues,a=z+"\n\n";if(S={},D("onchange",w.textTracks)){for(var n=0;n<t.length;n++){var i=t[n];i.id=i.id.replace(/[\d]+/g,n+1),S[i.id]=i,a+=i.id+"\n",a+=ie(i),a+=i.text+"\n\n"}k.val(a)}},M=function(){var t=e.Deferred(),a=!!$&&L[$],n=!!a&&a.activeCues;return!E&&n?(n.length>0?(V=n[0],h.fadeIn()):(V={id:"",text:"",startTime:"",endTime:""},h.hide()),d.text(V.id),""!==V.startTime?p.val(ee(V.startTime)):p.val(""),""!==V.endTime?v.val(ee(V.endTime)):v.val(""),T.val(ne(V.text))):V=n?n[0]:{id:"",text:"",startTime:"",endTime:""},t.resolve(),t.promise()},F=function(){w.pause();var t=d.text().replace(/^([\d]+|NEW) ?.*/,"$1"),a=p.val(),n=v.val(),r=T.val().replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/[\n]{2,}/g,"\n");if(r=ae(r),a&&n&&r&&a<n){if(t=t.replace(/^NEW/,Object.keys(S).length+1),S[t])j={id:S[t].id,text:S[t].text,startTime:S[t].startTime,endTime:S[t].endTime},S[t]=e.extend({},S[t],{id:t,text:r,startTime:te(a),endTime:te(n)});else{j={id:"",text:"",startTime:"",endTime:""};var o=new VTTCue(te(p.val()),te(v.val()),r);S[t]=e.extend({},o,i),S[t].id=t}var c=z+"\n\n";Object.keys(S).length&&e.each(S,function(e,t){var a=t;c+=a.id+"\n",c+=ie(a),c+=a.text+"\n\n"}),k.val(c),de("set")}else alert("Error Exists")},Q=function(){w.pause();var t=d.text().replace(/^([\d]+) ?.*/,"$1");if(window.confirm(I))if(S[t]){var a=z+"\n\n";Object.keys(S).length&&e.each(S,function(e,n){var i=n;i.id!=t&&(a+=i.id+"\n",a+=ie(i),a+=i.text+"\n\n")}),k.val(a),de("unset")}else alert("Error Exists")},_=function(){d.text(""),T.val(""),p.val(""),v.val(""),e(".readyActiveCue.editNow").removeClass("editNow"),re(".cueLoading").then(function(){E=!1;var t=e.Deferred();return e.when(oe(".cueLoading"),M()).then(function(){t.resolve()}),t.promise()}).then(function(){m.hide(),g.hide(),k.attr({readonly:"readonly"}),x.css({opacity:1}).off("click").on("click",H)}).catch(function(e){E=!0,console.log(e)})},H=function(){x.off("click",H),N=k.val(),k.removeAttr("readonly").addClass("editNow"),C.fadeIn(),y.fadeIn(),p.attr({readonly:"readonly"}),v.attr({readonly:"readonly"}),T.attr({readonly:"readonly"}),e(".setCurrentTime").css({opacity:.5}).off("click"),h.css({opacity:.5}).off("click"),e(".readyActiveCue").off("keyup focus blur")},K=function(){var e=k.val().replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/^WEBVTT.*\n\n/,""),t=e.match(/.+\n\d{2}:\d{2}:\d{2}\.\d{3} --> \d{2}:\d{2}:\d{2}\.\d{3}.*\n/g)||[],a=e.split(/.+\n\d{2}:\d{2}:\d{2}\.\d{3} --> \d{2}:\d{2}:\d{2}\.\d{3}.*\n/).slice(1)||[];if(t.length===a.length&&t.length>0){e=z+"\n\n";for(var n=0;n<a.length;n++)if(a[n]=a[n].replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/[\n]{2,}/g,"\n"),a[n]){t[n]=t[n].replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"");var r=t[n].match(/^(.+\n\d{2}:\d{2}:\d{2}\.\d{3} --> \d{2}:\d{2}:\d{2}\.\d{3})(.*)$/);if(r){e+=r[1];var o={};r[2].split(" ").map(function(e){if(e.length){var t=e.split(":");2===t.length&&t[0].match(/^vertical|region|line|position|size|align$/)&&(o[t[0]]=t[1])}}),o.vertical&&o.vertical.match(/^lr|rl$/)||(o.vertical=i.vertical),o.region&&o.region.length||(o.region=i.region),o.line&&o.line.match(/^\d+%?|auto$/)||(o.line="auto"===i.line||i.snapToLines?i.line:i.line+"%"),o.position&&o.position.match(/^\d+%|auto$/)||(o.position="auto"===i.position?i.position:i.position+"%"),o.size&&o.size.match(/^\d+%$/)||(o.size=i.size+"%"),o.align&&o.align.match(/^start|end|left|right$/)||(o.align=i.align)}o.vertical&&(e+=" vertical:"+o.vertical),o.region&&(e+=" region:"+o.region),e+=" line:"+o.line+" position:"+o.position+" size:"+o.size+" align:"+o.align+"\n",e+=a[n].replace(/-->/g,"--&gt;")+"\n\n"}k.val(e),setTimeout(function(){window.confirm("VTT file contents is fixed auto.\nSave fixed VTT contents, push OK.\nCheck VTT contents, push Cancel.")&&de("vtt")},100)}else alert("VTT file format error exists!")},U=function(){re(".vttLoading").then(function(){var t=e.Deferred();return k.attr({readonly:"readonly"}).removeClass("editNow"),x.css({opacity:1}).off("click").on("click",H),e(".readyActiveCue").off("keyup focus blur").on("keyup focus blur",Z),C.hide(),y.hide(),p.removeAttr("readonly"),v.removeAttr("readonly"),T.removeAttr("readonly"),e(".setCurrentTime").css({opacity:1}).off("click").on("click",X),h.css({opacity:1}).off("click").on("click",Q),k.val(N),t.resolve(),t.promise()}).then(function(){oe(".vttLoading")}).catch(function(e){console.log(e)})},G=function(){w.pause();d.text();window.confirm(I)&&(k.val(""),de("delete"))},J=function(){var e=ee(this.currentTime);o.val(e)},X=function(t){w.pause();var a=ee(w.currentTime);o.val(a);var n=e(this).attr("data-set");e("input."+n).val(a).trigger("keyup")},Y=function(e){var t=o.val();t.match(/^\d{2}:\d{2}:\d{2}\.\d{3}$/)&&("keyup"===e.type&&(w.currentTime=te(t)),$&&M())},Z=function(){var t=p.val(),a=v.val(),n=T.val().replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/[\n]{2,}/g,"\n"),i=!(!t.match(/^\d{2}:\d{2}:\d{2}\.\d{3}$/)||!a.match(/^\d{2}:\d{2}:\d{2}\.\d{3}$/));t&&a&&i&&t<a?n===ne(V.text)&&t===ee(V.startTime)&&a===ee(V.endTime)?(m.hide(),T.val()!==ne(V.text)?g.show():g.hide()):(n.replace(/[\n]{2,}/g,"\n").replace(/\n$/,"").length?m.fadeIn():m.hide(),g.fadeIn()):(m.hide(),E||g.hide()),n&&n===ne(V.text)&&t===ee(V.startTime)&&a===ee(V.endTime)?(e(".readyActiveCue").removeClass("editNow"),E=!1,x.css({opacity:1}).off("click").on("click",H)):((t||a||n.replace(/^[ \r\n\t\f]+$/,""))&&!E&&(d.text()||d.text("NEW"),e(".readyActiveCue").addClass("editNow"),E=!0,g.fadeIn(),k.attr({readonly:"readonly"}),x.css({opacity:.5}).off("click")),t||a||n.replace(/^[ \r\n\t\f]+$/,"")||!E||"NEW"===d.text()&&(d.text(""),e(".readyActiveCue").removeClass("editNow"),E=!1,g.hide(),x.css({opacity:1}).off("click").on("click",H)))},ee=function(e){var t=Math.floor(e),a="000"+String(Math.round(1e3*e-1e3*t));a="."+a.substr(-3);var n=t%3600,i=n%60,r=(t-n)/60;return n=(t-i)/60,("0"+r).slice(-2)+":"+("0"+n).slice(-2)+":"+("0"+i).slice(-2)+a},te=function(e){return 3600*Number(e.substr(0,2))+60*Number(e.substr(3,2))+Number(e.substr(6))},ae=function(e,t){t=t||!1;return e=(e=e.replace(/&/g,"&amp;")).toString().replace(/</g,"&lt;").replace(/>/g,"&gt;"),t&&(e=(e=(e=e.replace(/ /g,"&nbsp;")).replace(/'/g,"&#0*39;")).replace(/"/g,"&quot;")),e},ne=function(e,t){t=t||!1;return e=(e=e.toString().replace(/&lt;/g,"<").replace(/&gt;/g,">")).replace(/&amp;/g,"&"),t&&(e=(e=(e=e.replace(/&nbsp;/g," ")).replace(/&#0*39;|&apos;|&#x0*27;/g,"'")).replace(/&lrm;|&rlm;/g,"")),e},ie=function(e){var t="";return e&&(t+=ee(e.startTime)+" --\x3e "+ee(e.endTime),e.region&&(t+=" region:"+e.region),!e.vertical||"lr"!==e.vertical&&"rl"!==e.vertical||(t+=" vertical:"+e.vertical),"number"==typeof e.line&&e.line>=0&&e.line<=100&&!e.snapToLines?t+=" line:"+e.line+"%":"number"==typeof e.line&&e.snapToLines?t+=" line:"+e.line:t+=" line:auto","number"==typeof e.position&&e.position>=0&&e.position<=100?t+=" position:"+e.position+"%":t+=" position:auto","number"==typeof e.size&&e.size>=0&&e.size<=100?t+=" size:"+e.size+"%":t+=" size:100%","start"===e.align||"end"===e.align||"left"===e.align||"right"===e.align?t+=" align:"+e.align:t+=" align:center",t+="\n"),t},re=function(t){var a=e.Deferred();return e(t).find(".nowLoading").fadeIn(300,function(){a.resolve()}),a.promise()},oe=function(t){var a=e.Deferred();return e(t).find(".nowLoading").fadeOut(300,function(){a.resolve()}),a.promise()},ce=function(){re(".vttLoading")},le={200:function(){},302:function(){s.text("Ajax error. Status code 302")},404:function(){s.text("Ajax error. Status code 404")},501:function(){s.text("Ajax error. Status code 501")}},de=function(t,a){var i="delete"===t?"d":"u";a=a||0;var r=new FormData;null!=n.oAuth&&r.append("auth",n.oAuth),r.append("media",w.src),r.append("vtt",e("#"+$).attr("src").replace(/\?t=\d+$/,"")),r.append("cue",k.val()),r.append("crud",i);var o=e.extend({},n.ajax,{beforeSend:ce,statusCode:le,data:r});e.ajax(o).done(function(e,a,n){se(e,t)}).fail(function(e,i,r){"timeout"===i&&a<n.ajaxTimeoutReTry?(++a,setTimeout(function(){de(t,a)},1e3*a)):s.text("Ajax error. errorThrown: "+r)}).always(function(e,t){s.show(),setTimeout(function(){s.fadeOut(function(){s.removeClass("error").text("")})},3e3),oe(".vttLoading")})},se=function(t,a){t.msg;if(!t.result)return s.addClass("error").text(t.msg),V=e.extend({},V,j),void("vtt"===a?k.val(t.cue):k.val(t.vtt_contents));if("delete"===a){for(;L[$].cues.length;)L[$].removeCue(L[$].cues[0]);l.find("option").prop("selected",!1),l.find("option").eq(0).prop("selected",!0),l.trigger("change"),k.val("")}else if("unset"===a){var n=L[$].cues[parseInt(d.text(),10)-1];L[$].removeCue(n)}else if("NEW"===d.text()){var r=T.val().replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/[\n]{2,}/g,"\n");r=ae(r);n=new VTTCue(te(p.val()),te(v.val()),r);(n=e.extend(n,i)).id=L[$].cues.length+1,L[$].addCue(n)}else if("vtt"===a){var o=t.vtt_contents.split(/[\n]{2}/);for(o[0].match(/^WEBVTT/)&&o.shift();L[$].cues.length;)L[$].removeCue(L[$].cues[0]);for(var c=0;c<o.length;c++){var u=o[c].match(/^(.+)\n(\d{2}:\d{2}:\d{2}\.\d{3}) --> (\d{2}:\d{2}:\d{2}\.\d{3})(.*)\n([\d\D]*)$/);if(u){var f={name:u[1],start:u[2],end:u[3],text:u[5]},m=(n=new VTTCue(te(f.start),te(f.end),f.text),{});u[4].split(" ").map(function(e){if(e.length){var t=e.split(":");2===t.length&&("line"===t[0]&&t[1].match(/^\d+|auto$/)&&(m.snapToLines=!0),"line"===t[0]&&t[1].match(/^\d+%$/)&&(m.snapToLines=!1),t[1]=String(t[1]).replace(/%$/,""),t[1].match(/^\d+$/)&&(t[1]=Number(t[1])),m[t[0]]=t[1])}}),i.lineAlign&&(m.lineAlign=i.lineAlign),i.positionAlign&&(m.positionAlign=i.positionAlign),(n=e.extend(n,m)).id=f.name,L[$].addCue(n)}}}else{(n=L[$].cues[parseInt(d.text(),10)-1]).text=T.val().replace(/^[ \r\n\t\f]+/,"").replace(/[ \r\n\t\f]+$/,"").replace(/[\n]{2,}/g,"\n"),n.text=ae(n.text),n.startTime=te(p.val()),n.endTime=te(v.val())}"delete"!=a&&(k.attr({readonly:"readonly"}).removeClass("editNow"),x.css({opacity:1}).off("click").on("click",H),e(".readyActiveCue").off("keyup focus blur").on("keyup focus blur",Z),C.hide(),y.hide(),p.removeAttr("readonly"),v.removeAttr("readonly"),T.removeAttr("readonly"),e(".setCurrentTime").css({opacity:1}).off("click").on("click",X),h.css({opacity:1}).off("click").on("click",Q),q(L[$]),A.one("canplaythrough",M)),s.text(t.msg),g.trigger("click")};!function(){var t=e("<div />").attr({id:n.wrapperId});A.wrap(t),r=e("#"+n.wrapperId);var a=e("<div />").addClass("videoControlls");o=e("<input />").attr({type:"text",value:"00:00:00.000"}).addClass("currentTime");var i=" ";if(n.playbackRate.length>1){c=e("<select />").addClass("playSpeed");for(var $=0;$<n.playbackRate.length;$++){var V=e("<option />");V.attr({value:n.playbackRate[$]}).text("x "+n.playbackRate[$]),"1.0"===n.playbackRate[$]&&V.prop("selected",!0),c.append(V)}i=" Play Speed "}l=e("<select />").addClass("closedCaption setLanguage"),Object.keys(n.setLanguage).length&&e.each(n.setLanguage,function(t,a){var i=e("<option />");if(""===a.lang)i.attr({value:"","data-track":""}).text(a.label),n.selectTrack||i.prop("selected",!0);else{var r=n.trackIdPrefix+t;i.attr({value:a.lang,"data-track":r}).text(a.label);var o=w.src.replace(/(\.[a-z\d]+)$/i,"")+t+".vtt",c=e("<track />").attr({id:r,kind:"captions",label:a.label,srclang:a.lang,src:o});A.append(c)}l.append(i)}),a.append(" Current Time ",o,i,c," Closed Caption ",l),r.append(a);for($=0;$<w.textTracks.length;$++)w.textTracks[$].id||(w.textTracks[$].id=e("track").eq($).attr("id")),L[w.textTracks[$].id]=w.textTracks[$];var N=e("<div />").addClass("vttControlls").hide();d=e("<span />").addClass("cueName"),s=e("<span />").addClass("cueMsg");var E=e("<p />").addClass("cueHead").append("Cue identifier",d,s),S=e("<p />").text("Active Cue ").addClass("activeCueControlls");u=e("<span />").attr({"data-set":"cueStart"}).addClass("btn setCurrentTime").text("Start"),p=e("<input />").attr({type:"text",name:"cueStart",value:""}).addClass("readyActiveCue cueStart"),f=e("<span />").attr({"data-set":"cueEnd"}).addClass("btn setCurrentTime").text("End"),v=e("<input />").attr({type:"text",name:"cueEnd",value:""}).addClass("readyActiveCue cueEnd"),g=e("<span />").addClass("btn resetCue").text("Reset").hide(),m=e("<span />").addClass("btn setCue").text("Set Cue").hide(),h=e("<span />").addClass("btn unsetCue").text("Unset Cue").hide(),S.append(u,p,f,v,g,m,h),T=e("<textarea />").attr({name:"activeCue",rows:10}).addClass("readyActiveCue");var j=e("<p />").text("VTT File ").addClass("cueListControlls");x=e("<span />").addClass("btn editVtt").text("Edit VTT"),y=e("<span />").addClass("btn resetVtt").text("Reset VTT").hide(),C=e("<span />").addClass("btn setVtt").text("Set VTT").hide(),b=e("<span />").addClass("btn deleteVtt").text("Delete VTT").hide(),j.append(x,y,C,b),k=e("<textarea />").attr({name:"vtt",rows:30,readonly:"readonly"}).addClass("cueList");var z=e("<span />").text("Loading ...").wrap("<div />"),I=e("<div />").addClass("nowLoading").append(z),D=e("<div />").addClass("cueLoading"),R=e("<div />").addClass("vttLoading");D.append(T,I.clone()),R.append(k,I.clone()),N.append(E,S,D,j,R),r.append(N),m.hide(),g.hide(),h.hide()}(),A.on("timeupdate",J),e(".setCurrentTime").on("click",X),o.on("keyup",Y),A.on("seeked",Y),o.on("focus",function(){w.pause()}),e(".playSpeed").on("change",function(){w.playbackRate=e(this).val()}),w.volume=n.defaultVolume,e(".readyActiveCue").on("keyup focus blur",Z),m.on("click",F),h.on("click",Q),g.on("click",_),x.on("click",H),C.on("click",K),y.on("click",U),b.on("click",G),l.on("change",O),D("onchange",w.textTracks)?w.textTracks.onchange=B:(e("track").one("load",R),e("track").one("error",W)),n.selectTrack&&l.find("option[data-track='"+n.trackIdPrefix+n.selectTrack+"']").prop("selected",!0),setTimeout(O,1e3)}}(jQuery);